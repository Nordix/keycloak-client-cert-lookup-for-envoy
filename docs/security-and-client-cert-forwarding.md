# Understanding Client Certificate Forwarding and Security Implications

This document outlines the security implications and risks of enabling client certificate forwarding in reverse proxies.
These concerns are not exclusive to Envoy but apply to any reverse proxy that forwards client certificates.
The initial architectural assumption is that all requests originate from the proxy, preventing direct client access to Keycloak.
However, in environments like Kubernetes, some clients may bypass the proxy, leading to additional considerations.


## Overview

The `x-forwarded-client-cert` (XFCC) header is used by Envoy proxy to send the client certificate information to the backend service, such as Keycloak.
When Envoy terminates an external TLS connection initiated by a client, it performs a TLS handshake.
During this handshake, the client can present a client certificate.
Envoy verifies that the client possesses the corresponding private key and validates the certificate.
After successful validation, Envoy forwards the certificate to the backend service via the XFCC header.
Keycloak then uses the certificate for authorization purposes.

![image](assets/xfcc-intro.drawio.svg)


## Scenarios

### Scenario 1: Failed Authentication of an Client Running Inside the Proxy's Perimeter

Pre-conditions:

* Keycloak is configured with the X509 client certificate lookup SPI for Envoy proxy.
* A client is created to Keycloak with "X509 client certificate" client authenticator enabled.
* A client running inside Kubernetes cluster connects to Keycloak directly, without going through the Envoy proxy, using mutually authenticated TLS.

Scenario:

Authentication fails because the SPI implementation expects the identity from the XFCC header, which is not set for internal clients.
The client certificate information from the TLS layer is not used.

![image](assets/xfcc-scenario-1.drawio.svg)

### Scenario 2: Malicious Client Inside the Proxy's Perimeter Performs Identity Spoofing

Pre-conditions:

* Keycloak is configured with the X509 client certificate lookup SPI for Envoy proxy.
* A client is created to Keycloak with "X509 client certificate" client authenticator enabled.
* A malicious user has acquired (1) the client ID and (2) the subject name of the client certificate.
* Malicious user has gained access to the cluster e.g., through a compromised pod.

Scenario:

A malicious client within the cluster uses a forged certificate in the XFCC header to impersonate a client identity without proving possession of the private key associated with a legitimate client certificate.
This can include a Keycloak admin client to obtain full access to Keycloak.
The forged certificate can be self-generated by the malicious user, as long as it contains the correct subject name.

![image](assets/xfcc-scenario-2.drawio.svg)


## TEST

This is a test

![image](assets/client-authorization-flow.drawio.svg)
