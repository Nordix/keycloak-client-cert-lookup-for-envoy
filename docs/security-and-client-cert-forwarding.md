<!-- Note for contributors: -->
<!-- The images in this document are drawn in https://app.diagrams.net/. -->
<!-- To edit the images in the editor to see the original vector diagram. -->
<!-- When saving the updated diagram, remember include copy of the original diagram -->

# Understanding Client Certificate Forwarding and Security Implications

This document outlines the security implications and risks of enabling client certificate forwarding in reverse proxies.
These concerns are not exclusive to Envoy but apply to any reverse proxy that forwards client certificates.
The initial architectural assumption is that all requests originate from the proxy, preventing direct client access to Keycloak.
However, in environments like Kubernetes, some clients may bypass the proxy, leading to additional considerations.


## Overview

`x-forwarded-client-cert` (XFCC) is a proxy header which indicates certificate information of the client, determined by Envoy when terminating the external TLS connection established by the client.
Envoy terminates the TLS connection and validates the client certificate.
If the certificate is valid, Envoy forwards the certificate information to the backend service, such as Keycloak, in the XFCC header.

![image](assets/xfcc-intro.drawio.svg)


## Scenarios

### Scenario 1: Failed Authentication of an Client Running Inside the Proxy's Perimeter

Pre-conditions:

* Keycloak is configured with the X509 client certificate lookup SPI for Envoy proxy.
* A client is created to Keycloak with "X509 client certificate" client authenticator enabled.
* A client running inside Kubernetes cluster connects to Keycloak directly, without going through the Envoy proxy, using mutually authenticated TLS.

Scenario:

Authentication fails because the SPI implementation expects the identity from the XFCC header, which is not set for internal clients.
Therefore, the client certificate is not retrieved from the TLS connection.

![image](assets/xfcc-scenario-1.drawio.svg)

### Scenario 2: Malicious Client Inside the Proxy's Perimeter Performs Identity Spoofing

Pre-conditions:

* Keycloak is configured with the X509 client certificate lookup SPI for Envoy proxy.
* A client is created to Keycloak with "X509 client certificate" client authenticator enabled.
* A malicious user has acquired (1) the client ID and (2) the subject name of the client certificate.
* Malicious user has gained access to the cluster e.g., through a compromised pod.

Scenario:

A malicious client within the cluster uses a forged certificate in the XFCC header to impersonate a client identity without proving possession of the private key associated with a legitimate client certificate.
This can include a Keycloak admin client to obtain full access to Keycloak.
The forged certificate can be self-generated by the malicious user, as long as it contains the correct subject name.

![image](assets/xfcc-scenario-2.drawio.svg)
